# Docker導入のすすめ

## 開発と本番の差異

アプリケーションを開発を行っていると、開発機と本番機の環境が異なっていることがよくあることだろう。

開発機はWindows、本番機はLinuxとまずOSの違いがあり、またランタイムのバージョンの違いがあり、さらにPHPがモジュール版とFPM版とで違いがあり……と少し上げてみるだけでかなりの量があることに気が付く。

実際、納品時にプログラムがエラーを起こしてはじめてこの際に気付くことすらもよくあることである。

## 従来の開発環境

これまで、こういった環境の差異を埋めるのにはVMwareやVirtualboxなどの仮想化技術がよく使われていた。
Windows上でLinux環境を起動したり、そもそも仮想化用のOSを起動してその上にLinux環境を複数用意したり、などといった感じだ。

しかしこのVM（バーチャルマシン＝仮想マシン）は弱点があった。
ホストとなるWindows等へ要求するマシンのスペックが高いのである。

VMは基本的にCPUやメモリを分割してLinuxなどに分け与えることとなるため、そもそものスペックが高めでなければすぐにリソース不足に陥ってしまい、結果的にそれが処理落ち、障害等に繋がってしまう。

開発に使用する環境がしょっちゅう処理落ちしていてはとてもやっていられないのである。

## Dockerのメリット

![仮想マシンとコンテナの違い](./diff_vm_and_container.png "仮想マシンとコンテナの違い")
出典：[VMとDockerについて比較してみた #Docker - Qiita](https://qiita.com/moonorange/items/ee67491fde07fa55fae4)

今回紹介するDockerは、これまでのVMの弱点を補うように登場した「コンテナ開発」の技術を扱うものである。

コンテナはアプリケーションを実行するための領域を複数に分割して利用するものであり、概念としてはこれまでのVMとは大きく異なっている。

大きな特徴としては、ApacheやPHP、PostgreSQLなどの小さなサービス単位でコンテナを分割して起動し、複数のコンテナを組み合わせて環境を作成するというもので、これによって非常に軽量な動作が実現されている。従来のVMに比べるとその差は歴然である。

コンテナはOSではないため、CPUやメモリの消費が少なくストレージの使用も僅かになっており、ホストマシンと領域を共有しているためファイルの共有も容易である。

また、Docker等で作成した環境はコピーがしやすくなっており、どのマシンに入れても同じ環境を作ることができるため環境の差異を極めて小さくすることができる。これをよく「可搬性が高い」と言われている。

これはつまり、ホストマシンの環境を汚さないことにも繋がる。インストールするのはDockerのみで、その後はPHPもNode.jsもインストールすることなく実行環境を作ることができる。

## Dockerのデメリット

ここまでDockerのデメリットについて述べてきたが、当然Dockerにもデメリットは存在している。これから述べるデメリットについて理解した上でDockerを利用することをお勧めする。

まず、Dockerは基本的にLinux環境である。そしてホストマシンはふつうWindowsである。この違いが結構大きな障害となることがある。

開発時はWindowsにあるソースコードをDockerにマウントするような形になることがあるのだが、Dockerからソースコードを参照すると、都度WindowsからLinuxへのファイル変換が行われてしまい、プログラムの実行に大きな遅延が発生してしまうのである。

これはDockerのというよりWSLの問題であり、WSL1から現在のバージョンのWSL2にバージョンアップした際にこのあたりのファイルシステムが変わったようで、WSL1よりもWSL2の方がファイルのアクセスが低速になった模様である。

（参考：[WSL2でファイルシステムのアクセス速度がどの程度変わったか #Java - Qiita）](https://qiita.com/penguinsan/items/97f42f1e67eb432f9978)

ただしこれも回避方法がある。LinuxからWindowsへのアクセスが遅いのであればLinux上にファイルを配置してしまえばよいのである。

[WindowsでDockerを使う時、正しくファイル配置しないと激重になるので注意 #初心者 - Qiita](https://qiita.com/minato-naka/items/84508472c04f628e576e)

こちらの記事のように設定することで速度については大きく改善される。注意点としては、Linux側にファイルを配置するためWindows側からのアクセスは若干遅くなる。

実務上問題はあまりないかと思うが、これに抵抗感がある場合は従来通りWindowsで環境を作った方がいいだろう。

## まとめ

Dockerを使用することで、改行コードやパスの記法、Shell・Batchの記法など、エンジニアを悩ませる煩わしいOSの差異を意識することなく開発を進めることができる。
例えば、WindowsでPHPアプリを動作させようとしたとき、フルパスで直書きされている部分を書き換えする必要があるとすると、この作業が不要となる。

快適な開発を進めていくために、この機会にDockerを導入してみることを推奨したい。
